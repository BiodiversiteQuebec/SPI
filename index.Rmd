---
title: "Indicateur de protection des espèces"
output:
  html_document:
    toc: true
    number_sections: true
    toc_float: true
---
# Points clé

## **Augmentation de la protection de toutes les espèces ciblées au cours des 61 dernières années**  
Augmentation minimale de 1% pour la Salamande sombre des montagnes (*Desmognathus ochrophaeus*)  
Augmentation maximale de 70% pour la Rainette faux grillon (*Pseudacris maculata*)  
Avec une moyenne de 11% pour les xxx espèces considérées  
À mettre en lien avec le seuil Aichi de 17%  

## **Etat de la protection des espèces du nord vs. du Sud**  
*Une espèce est considérée du nord si la latitude du centroïde de son aire de répartition est supérieure à 55°. Inversement, une espèce dont la latitude du centroïde de son aire de répartition est inférieure ou égale à cette valeur seuil, sera considérée comme une espèce du sud.*  
Les espèces du Nord présentent un SPI moyen de 17% (sd = 4%).  
Les espèces du Sud présentent un SPI moyen 9% (sd = 8%).  

## **Moments marquants de la création des aires protégées**  
Farfouiller autour des années 1981 et 2003 qui correspondent à une augmentation importante de la superficie des aires protégées.  

## **Identification d'espèces extrêmes en terme de protection**  
cf la Salamandre sombre des montagnes et la Rainette faux grillon

## **Représentativité des espèces dans les aires protégées**  


# Visualisation  

```{r, include = F}
# packages
require(knitr)
require(mapview)
require(plotly)
require(sf)
require(terra)
require(htmltools)
library(viridis)
library(smoothr)

# raw data
aire_prot_union <- st_read("/home/claire/BDQC-GEOBON/GITHUB/SPI/data_clean/aires_protegees_union.gpkg")
SPI <- read.csv("results/SPI.csv")[, -1]
names <- as.character(unique(SPI$SPECIES))
years <- as.numeric(unique(SPI$YEAR))

# produced data
# ---

all_sm <- data.frame()
for (i in names) {
    m <- cbind(SPI$YEAR[SPI$SPECIES == i], SPI$SPI[SPI$SPECIES == i])
    sm <- smooth_ksmooth(m, smoothness = 4)
    df <- as.data.frame(sm)
    names(df) <- c("YEAR", "SPI")
    df$SPECIES <- i
    df$YEAR2 <- ceiling(df$YEAR)
    all_sm <- rbind(all_sm, df)
}

df_max <- SPI[SPI$SPECIES == "Pseudacris maculata", ]
df_min <- SPI[SPI$SPECIES == "Desmognathus ochrophaeus", ]
s_max <- smooth_ksmooth(as.matrix(df_max[, c(3, 2)]), smoothness = 4)
s_min <- smooth_ksmooth(as.matrix(df_min[, c(3, 2)]), smoothness = 4)
# ---
last_spi <- read.csv2("/home/claire/BDQC-GEOBON/GITHUB/SPI/data_clean/SPI_north_south.csv")

# Output figure in HTML5
# if (knitr::is_html_output()) {
#     knitr::knit_hooks$set(
#         plot = function(x, options) {
#             cap <- options$fig.cap # figure caption
#             tags <- htmltools::tags
#             as.character(tags$figure(
#                 tags$img(src = x, alt = cap),
#                 tags$figcaption(cap)
#             ))
#         }
#     )
# }
```

## Figure 1  
SPI en fonction du temps avec sp minimale et sp maximale 
 - recupérer tous les SPI avec code couleur nord/sud  
 - gam sur les valeurs moyennes
 - gam sur les deux espèces min et max

```{r}
g <- plot_ly() |> add_lines(x = ceiling(s_max[, 1]), y = s_max[, 2], color = I("#238A8DFF"))

for (i in names) {
    sm <- all_sm[all_sm$SPECIES == i, ]
    g <- add_lines(g,
        x = sm$YEAR,
        y = sm$SPI,
        color = I("lightgrey"),
        text = i
    )
}
g <- add_lines(g, x = ceiling(s_mm[, 1]), y = s_mm[, 2], color = I("#238A8DFF"))
g <- add_lines(g, x = ceiling(s_min[, 1]), y = s_min[, 2], color = I("#B8DE29FF"))
g <- add_lines(g, x = ceiling(s_max[, 1]), y = s_max[, 2], color = I("#404788FF"))
g |> layout(
    showlegend = F,
    yaxis = list(zeroline = FALSE, title = "SPI"),
    xaxis = list(zeroline = FALSE, title = "Année")
)
```

## Figure 2
```{r, echo=F, warning = FALSE}
# color definition
# viridis_pal <- viridisLite::viridis(20)
# scales::show_col(viridis_pal)
# pal <- c(viridis_pal[11], "#DCE318FF")
# pal2 <- setNames(pal, c("North", "South"))
# colors <- ifelse(last_spi$LOC == "North", viridis_pal[11], "#DCE318FF")

# conversion from species characters to ordered levels of factor for keeping increasing SPI
last_spi$SPECIES2 <- factor(last_spi$SPECIES, levels = last_spi$SPECIES[order(last_spi$SPI, decreasing = FALSE)])

# fonction for drawing a vertical line
vline <- function(x = 0, color = "#238A8DFF") {
    list(
        type = "line",
        y0 = 0,
        y1 = 1,
        yref = "paper",
        x0 = x,
        x1 = x,
        line = list(color = color, dash = "dot")
    )
}

fig <- plot_ly() |>
    add_bars(
        data = last_spi,
        x = ~SPI,
        y = ~SPECIES2,
        type = "bar",
        orientation = "h",
        color = ~LOC,
        # colors = pal2,
        hovertemplate = paste(
            "<b>%{y}</b><br>",
            "<b>SPI</b> = %{x}"
        )
    ) |>
    layout(
        yaxis = list(zeroline = FALSE, title = "Espèce", showticklabels = FALSE),
        xaxis = list(zeroline = FALSE),
        shapes = list(vline(0.17, color = "black"))
    )
# print(fig)
fig
```
## Figure 3

```{r, echo=F}
mapview(aire_prot_union, col.regions = "#238A8DFF")
```